##
# Copyright (2016) Hewlett Packard Enterprise Development LP
#
# Licensed under the Apache License, Version 2.0 (the "License");
# You may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
###
## Deploy a New Server Profile and Server using a Server profile Template
- hosts: all
  vars:
    config: "{{ playbook_dir }}/oneview_config.json"
    ov_template: "ESXI_Automate_Template"
    auto_assign_server_hardware: "true"
    # server_hardware_name: "2-Synergy105-M, bay 1"
    # enclosure_group_name:
    network_1_name: "Deploy"
    network_2_name: "Mgmt"
    deployment_plan_name: "ESX6.5U1 FCOE"
    management_network: "LAB1"
  tasks:
    - name: "Ensure the Server Profile is present with the OS Deployment Plan '{{ deployment_plan_name }}'"
      oneview_server_profile:
         config: "{{ config }}"
         data:
           name: Esxi Server
           server_template: "{{ ov_template }}"
           osDeploymentSettings:
              osDeploymentPlanName: '{{ deployment_plan_name }}'
              osCustomAttributes:
               - name: ManagementNIC.ipaddress
                 value: 10.10.105.30
               - name: Hostname
                 value: dude
               - name: DomainName
                 value: atlpss.hp.net
               - name: ManagementNIC.connectionid
                 value: 3
               - name: ManagementNIC.ipv4disable
                 value: false
               - name: ManagementNIC.constraint
                 value: userspecified
               - name: ManagementNIC.dhcp
                 value: false
               - name: ManagementNIC.netmask
                 value: 255.255.0.0
               - name: ManagementNIC.gateway
                 value: 10.10.1.4
               - name: ManagementNIC.dns1
                 value: 10.10.197.3
               - name: ManagementNIC.dns2
                 value: 10.10.197.2
               - name: ManagementNIC.networkuri
                 value: /rest/ethernet-networks/1a1ab96f-2797-434d-9e29-8d548675abde
               - name: ManagementNIC.vlanid
                 value: 0
               - name: SSH
                 value: enabled
               - name: Password
                 value: HP1nvent
      delegate_to: localhost

    - debug: var=server_profile

    - name: Power on the server hardware
      oneview_server_hardware:
        config: "{{ config }}"
        state: power_state_set
        data:
          name : "{{ server_hardware.name }}"
          powerStateData:
            powerState: "On"
            powerControl: "MomentaryPress"
      delegate_to: localhost

# Creating a new cluster in Vcenter
    - name: Create Cluster
      local_action:
        module: vmware_cluster
        hostname: 10.10.105.250 
        username: administrator@vsphere.local 
        password: HP1nvent!
        datacenter_name:  Dev
        cluster_name: dev_cluster
        validate_certs: False
        enable_ha: False
        enable_drs: True
        enable_vsan: False
      delegate_to: localhost

# Waiting for the server boot to complete, using Sleep, but need to look at waing on Port 22 option
    - name: sleep for 570 seconds and continue with play
      wait_for: timeout=570
      delegate_to: localhost

# Add the new ESXi host to the Cluster
    - name: Add ESXi Host to VCSA
      local_action:
        module: vmware_host
        hostname: 10.10.105.250
        username: administrator@vsphere.local
        validate_certs: False
        password: HP1nvent!
        datacenter_name: Dev
        cluster_name: dev_cluster
        esxi_hostname: 10.10.105.30
        esxi_username: root
        esxi_password: HP1nvent
        state: present
      delegate_to: localhost

# Create a new DVS
    - name: Create dvswitch
      local_action:
        module: vmware_dvswitch
        hostname: 10.10.105.250
        username: administrator@vsphere.local
        password: HP1nvent!
        datacenter_name: Dev
        switch_name: dvSwitch
        mtu: 1500
        uplink_quantity: 1
        discovery_proto: lldp
        discovery_operation: both
        state: present
        validate_certs: False
      delegate_to: localhost

# Add the ESXi host to the DVS
    - name: Add Host to dVS
      local_action:
        module: vmware_dvs_host
        hostname: 10.10.105.250
        username: administrator@vsphere.local
        password: HP1nvent!
        esxi_hostname: 10.10.105.30
        switch_name: dvSwitch
        vmnics:
         - vmnic5
        state: present
        validate_certs: False
      delegate_to: localhost

# Add a new Port Group to the DVS
    - name: Create Management portgroup
      local_action:
        module: vmware_dvs_portgroup
        hostname: 10.10.105.250
        username: administrator@vsphere.local
        password: HP1nvent!
        portgroup_name: vmaccess
        switch_name: dvSwitch
        vlan_id: 0
        num_ports: 12
        portgroup_type: earlyBinding
        state: present
        validate_certs: False
      delegate_to: localhost

# Had to find away to Register a VM Template since Ansible does not currenlt support Content Lib. Calling an external script
    - name: register template
      command: /root/registervm.sh
      delegate_to: localhost

# Spin up a Win2016 VM with SQL 2014 using the Template
    - name : Create VM
      local_action:
        module: vsphere_guest
        vcenter_hostname: syn105vcenter.atlpss.hp.net
        validate_certs: no
        username: administrator@vsphere.local
        password: HP1nvent!
        guest: newvm003
        from_template: yes
        template_src: WIN2016_SQL
        vm_nic:
         nic1:
         type: vmxnet3
         network: vmaccess
         network_type: dvs
        esxi:
         datacenter: Dev
         hostname: 10.10.105.30
      delegate_to: localhost
